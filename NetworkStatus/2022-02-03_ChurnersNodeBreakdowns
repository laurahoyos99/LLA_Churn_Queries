WITH AVERIASNODOS AS(
    
SELECT DISTINCT Ticket_ID, NODO, CAST(LEFT(Fecha_Inicio,10) AS DATE) AS FechaAveria
FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-01-13_CR_AVERIAS_NODOS_2020-12_A_2021-12_T`
WHERE Ticket_ID IS NOT NULL
AND (Ticket_Type = "Averia Planta Externa" OR Ticket_Type = "Averia Fibra" OR Ticket_Type = "AverÃ­a FTTH")
GROUP BY Ticket_ID, NODO, FechaAveria
),
USUARIOSNODOS AS(
 SELECT DISTINCT Account_Number, Node_Name
 FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-01-13_CR_CONEXION_USUARIOS_NODOS_2021_T` 
 GROUP BY Account_Number, Node_Name
),
CRUCEUSUARIOSAVERIAS AS(
 SELECT * 
 FROM AVERIASNODOS a INNER JOIN USUARIOSNODOS u 
 ON a.NODO = u.Node_Name
),
CHURNERS AS(SELECT DISTINCT NOMBRE_CONTRATO, FECHA_APERTURA, FECHA_FINALIZACION
  FROM
    `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-01-12_CR_ORDENES_SERVICIO_2021-01_A_2021-11_D` c INNER JOIN CRUCEUSUARIOSAVERIAS a on c.NOMBRE_CONTRATO = a.Account_Number
  WHERE TIPO_ORDEN = "DESINSTALACION" AND ESTADO = "FINALIZADA" AND FECHA_FINALIZACION IS NOT NULL AND FECHA_APERTURA IS NOT NULL
  AND FECHA_FINALIZACION > a.FechaAveria  AND DATE_DIFF ( FECHA_FINALIZACION, FechaAveria, DAY) <= 60
    GROUP BY NOMBRE_CONTRATO, FECHA_APERTURA, FECHA_FINALIZACION)
SELECT EXTRACT (MONTH FROM u.FechaAveria) as MES, COUNT (DISTINCT u.Account_Number) as NumContr, COUNT (DISTINCT c.NOMBRE_CONTRATO) as Churners
FROM CRUCEUSUARIOSAVERIAS u LEFT JOIN CHURNERS c ON u.Account_Number = c.NOMBRE_CONTRATO
GROUP BY MES
ORDER BY MES
