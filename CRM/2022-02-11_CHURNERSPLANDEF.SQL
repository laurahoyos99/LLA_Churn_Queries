WITH CHURNERSCRM AS(
    SELECT DISTINCT ACT_ACCT_CD, MAX(CST_CHRN_DT) AS MaxfechaC
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D`
    GROUP BY ACT_ACCT_CD
    HAVING EXTRACT (MONTH FROM MaxfechaC) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))
),
PRIMERCHURNMES AS(
    SELECT DISTINCT ACT_ACCT_CD, EXTRACT (MONTH FROM FECHA_EXTRACCION) AS MES, MIN(CST_CHRN_DT) MinFecha
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D` t
    group by ACT_ACCT_CD,MES
    HAVING extract(YEAR FROM Minfecha) = 2021
    AND EXTRACT (MONTH FROM Minfecha) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))
),
CRUCEMAXMINCHURN AS(
    SELECT DISTINCT c.ACT_ACCT_CD, p.MES, p.MinFecha, c.MaxfechaC
    FROM CHURNERSCRM c INNER JOIN PRIMERCHURNMES p ON c.ACT_ACCT_CD = p.ACT_ACCT_CD AND c.MaxfechaC >= p.MinFecha
    AND EXTRACT(MONTH FROM c.maxfechaC) = EXTRACT(MONTH FROM P.Minfecha))
,
PLANCHURNERS AS(
      SELECT DISTINCT ACT_ACCT_CD, extract(month from FECHA_EXTRACCION) AS MES
    , MIN(CST_CHRN_DT) AS MinfechaP,
    CASE
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NOT NULL THEN "3P"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NULL THEN "2P - BB+TV"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NOT NULL THEN "2P - BB+VO"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NOT NULL THEN "2P - TV+VO"
    WHEN  PD_BB_PROD_ID IS NOT NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NULL THEN "1P - BB"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NOT NULL AND PD_VO_PROD_ID IS NULL THEN "1P - TV"
    WHEN  PD_BB_PROD_ID IS NULL AND PD_TV_PROD_ID IS NULL AND PD_VO_PROD_ID IS NOT NULL THEN "1P - VO"
    END AS PFLAG
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D`
    GROUP BY ACT_ACCT_CD, PFLAG, MES
    HAVING extract(YEAR FROM MinfechaP) = 2021
    AND EXTRACT (MONTH FROM MinfechaP) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))
),
CRUCEPLANMINCHURN AS(
    SELECT DISTINCT c.ACT_ACCT_CD, c.mes, c.MinFecha, p.Pflag
    FROM CRUCEMAXMINCHURN c INNER JOIN PLANCHURNERS p on C.ACT_ACCT_CD = p.ACT_ACCT_CD AND c.MinFecha = p.MinFechaP)
SELECT C.MES, C.PFLAG, COUNT(DISTINCT C.ACT_ACCT_CD)
FROM CRUCEPLANMINCHURN C
GROUP BY  MES, PFLAG
ORDER BY MES, PFLAG
