WITH CHURNERSBB AS(
     SELECT DISTINCT ACT_ACCT_CD, MAX(CST_CHRN_DT) AS MaxfechaBB,
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D`
    WHERE PD_BB_PROD_ID IS NOT NULL
GROUP BY ACT_ACCT_CD
 HAVING EXTRACT (MONTH FROM MAX(CST_CHRN_DT)) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))
),
 CHURNPLANGRAL AS(
 SELECT DISTINCT ACT_ACCT_CD,MAX(CST_CHRN_DT) AS Maxfecha,
    CASE
    WHEN  PD_BB_PROD_NM IN (
        --HFC
        '3A_INTERNET CT 30MBPS/3MBPS V3',
        'I0132B_CT INTERNET 30MB/3MB',
        'I0132_CT INTERNET 30MB/3MB',
        'I0131_CT INTERNET 30MB/2MB',
        '3A_COLABORADOR 30MBPS/3MBPS V3A',
        '3030A_INTERNET CT 30MBPS/3MBPS GRUPO 1 V2',
        '3030B_INTERNET CT 30MBPS/3MBPS GRUPO 2 V2',
        '3_COLABORADOR 30MBPS/3MBPS V3',
        '3030C_INTERNET CT 30MBPS/3MBPS GRUPO 3 V2',
        'I0124B_INTERNET CT 35MBPS/5MBPS',
        'I0117_INTERNET CT 35MBPS/5MBPS',
        'I0112_INTERNET CT 35MBPS/3MBPS',
        -- FTTH
         '3030A_INTERNET FTTH CT 35MBPS/15M GRUPO 1 V2',
        '3030B_INTERNET FTTH CT 35MBPS/15M GRUPO 2 V2',
        '3030C_INTERNET FTTH CT 35MBPS/15M GRUPO 3 V2',
        '30MBPS/30MBPS_FTTH_CT') THEN "30-35"
    WHEN PD_BB_PROD_NM IN (
        --HFC
        'I0121_INTERNET CT 75MBPS/5MBPS',
        '2021A_INTERNET CT 45MBPS/3MBPS',
        'I0139_INTERNET CT 50MBPS/5MBPS V2',
        'I0133_CT INTERNET 50MB/3MB',
        'I0136_CT INTERNET 50MB/5MB',
        'I0118_INTERNET CT 50MBPS/5MBPS',
        'I0118B_INTERNET CT 50MBPS/5MBPS',
        --FTTH
         'I10B_INTERNET FTTH CT 50MBPS/15MBPS',
        'I01_INTERNET FTTH CT 50MBPS/15MBPS V1',
        'I11_INTERNET FTTH CT 75M/15M',
        '45MBPS/25MBPS_FTTH_CT') THEN "45-75"
    WHEN PD_BB_PROD_NM IN(
        --HFC
        'I0141_INTERNET CT 100MBPS/5MBPS V3',
        'I0140_INTERNET CT 100MBPS/5MBPS V2',
        'I0141_COLABORADOR 100MBPS/5MBPS V3',
        '3030A_INTERNET CT 100MBPS/5MBPS GRUPO 1 V2',
        '3030B_INTERNET CT 100MBPS/5MBPS GRUPO 2 V2',
        '3030C_INTERNET CT 100MBPS/5MBPS GRUPO 3 V2',
        'I0119_INTERNET CT 100MBPS/5MBPS',
        --FTTH
        '100MBPS/5MBPS_FTTH_CT',
        'I0141_INTERNET FTTH 100MBPS/15MBPS V3',
        'SERVICIO INTERNET FTTH 100MB/15MB V2',
        '3030B_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 2 V2',
        '3030A_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 1 V2',
        '3030C_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 3 V2',
        'I01_INTERNET FTTH CT 100MBPS/15MBPS V1',
        '100MBPS/100MBPS_FTTH_CT') THEN "100"
    WHEN PD_BB_PROD_NM IN(
        --HFC
        'I0134_CT INTERNET 100MB/5MB',
        'I0114_INTERNET CT 100MBPS/3MBPS',
        'I0135_CT INTERNET 120MB/5MB',
        'I0135B_CT INTERNET 120MB/5MB',
        '3_INTERNET CT 150MBPS/5MBPS V3',
        'I0141_INTERNET CT 200MBPS/10MBPS V3',
        'I0141_COLABORADOR 200MBPS/10MBPS V3',
        '3030B_INTERNET CT 200MBPS/10MBPS GRUPO 2 V2',
        '3_INTERNET CT 200MBPS/10MBPS V3A',
        '3030A_INTERNET CT 200MBPS/10MBPS GRUPO 1 V2',
        --FTTH
         '200MBPS/10MBPS_FTTH_CT',
        '200MBPS/200MBPS_FTTH_CT',
        '150MBPS/75MBPS_FTTH_CT') THEN "101-200"
    WHEN PD_BB_PROD_NM IN(
        --HFC
        '3030C_INTERNET CT 200MBPS/10MBPS GRUPO 3 V2',
        '2021B_INTERNET CT 225MBPS/10MBPS',
        '2021C_INTERNET CT 300MBPS/10MBPS',
        --FTTH
          '200MBPS/10MBPS_FTTH_CT') THEN "201-300"
    WHEN PD_BB_PROD_NM IN(
        --HFC
        'RACSA INTERNET 256/64 KBPS',
        'INTERNET CT 512/128 KBPS',
        'RACSA INTERNET 512/128 KBPS',
        '005_INTERNET CT 1 MEGA/256 KBPS',
        'I0101_INTERNET CT 1MBPS/512KBPS',
        'RACSA INTERNET 1 MEGA/256 KBPS',
        'INTERNET CT 1.5 MEGAS/256 KBPS',
        'RACSA INTERNET 1.5 MEGAS/256 KBPS',
        'I0102_INTERNET CT 2MBPS/1MBPS',
        '006_INTERNET CT 2 MEGAS/512 KBPS',
        'I0102A_INTERNET CT 2MBPS/1MBPS GRUPO 1',
        'I0102B_INTERNET CT 2MBPS/1MBPS GRUPO 2',
        'I0102C_INTERNET CT 2MBPS/1MBPS GRUPO 3',
        'I0103_INTERNET CT 3MBPS/1MBPS',
        'I0125_CT INTERNET 3MB/1MB',
        '007_INTERNET CT 3MEGAS/512 KBPS',
        'INTERNET CT 3 MEGAS/256 KBPS',
        'I0103A_INTERNET CT 3MBPS/1MBPS GRUPO 1',
        'I0103B_INTERNET CT 3MBPS/1MBPS GRUPO 2',
        'I0103C_INTERNET CT 3MBPS/1MBPS GRUPO 3',
        'RACSA INTERNET 3 MEGAS/256 KBPS',
        'RACSA INTERNET 4 MEGAS/1 MEGA KBPS',
        'RACSA INTERNET 4 MEGAS/768 KBPS',
        '3030A_INTERNET CT 5MBPS/1MBPS GRUPO 1 V2',
        '3030B_INTERNET CT 5MBPS/1MBPS GRUPO 2 V2',
        '3030C_INTERNET CT 5MBPS/1MBPS GRUPO 3 V2',
        'I0126_CT INTERNET 5MB/1MB',
        'I0104_INTERNET CT 5MBPS/1.5MBPS',
        '009_INTERNET CT 5 MEGAS/512 KBPS',
        'I0109A_INTERNET CT 5MBPS/1MBPS GRUPO 1',
        'I0104A_INTERNET CT 5MBPS/1.5MBPS GRUPO 1',
        'I0109B_INTERNET CT 5MBPS/1MBPS GRUPO 2',
        '2020B_INTERNET CT 5MBPS/1MBPS GRUPO 2 V1',
        'I0104B_INTERNET CT 5MBPS/1.5MBPS GRUPO 2',
        'I0104C_INTERNET CT 5MBPS/1.5MBPS GRUPO 3',
        '2020C_INTERNET CT 5MBPS/1MBPS GRUPO 3 V1',
        '2020A_INTERNET CT 5MBPS/1MBPS GRUPO 1 V1',
        'I0109C_INTERNET CT 5MBPS/1MBPS GRUPO 3',
        'I0105_INTERNET CT 6MBPS/1.5MBPS',
        'I0106B_INTERNET CT 8MBPS/2MBPS',
        'I0106_INTERNET CT 8MBPS/1.5MBPS',
        'I0106A_INTERNET CT 8MBPS/1.5MBPS GRUPO 1',
        'I0106B_INTERNET CT 8MBPS/1.5MBPS GRUPO 2',
        'I0106C_INTERNET CT 8MBPS/1.5MBPS GRUPO 3',
        'I0127_CT INTERNET 10MB/1.5MB',
        'I0107_INTERNET CT 10MBPS/2MBPS',
        'I0110A_INTERNET CT 10MBPS/1.5MBPS GRUPO 1',
        'I0110B_INTERNET CT 10MBPS/1.5MBPS GRUPO 2',
        'I0110C_INTERNET CT 10MBPS/1.5MBPS GRUPO 3',
        'I0107A_INTERNET CT 10MBPS/2MBPS GRUPO 1',
        '010_INTERNET CT 10 MEGAS/1 MEGA',
        'I0107B_INTERNET CT 10MBPS/2MBPS GRUPO 2',
        'I0108_INTERNET CT 12MBPS/2MBPS',
        'I0138_INTERNET CT 15MBPS/3MBPS V2',
        'I0137_INTERNET CT 15MBPS/3MBPS V1',
        'I0141_INTERNET CT 15MBPS/3MBPS V3',
        'I0115_INTERNET CT 15MBPS/3MBPS',
        'I0128_CT INTERNET 15MB/1.5MB',
        '011_INTERNET CT 15 MEGAS/1 MBPS',
        'I0138A_INTERNET CT 15MBPS/3MBPS V2 GRUPO 1',
        'I0138B_INTERNET CT 15MBPS/3MBPS V2 GRUPO 2',
        'I0111A_INTERNET CT 15MBPS/1.5MBPS GRUPO 1',
        'I0111B_INTERNET CT 15MBPS/1.5MBPS GRUPO 2',
        'I0141_COLABORADOR 15MBPS/3MBPS V3',
        'I0138C_INTERNET CT 15MBPS/3MBPS V2 GRUPO3',
        'I0111C_INTERNET CT 15MBPS/1.5MBPS GRUPO 3',
        'I0109_INTERNET CT 15MBPS/2MBPS',
        'I0129_CT INTERNET 20MB/2MB',
        'I0112A_INTERNET CT 20MBPS/2MBPS GRUPO 1',
        'I0116_INTERNET CT 20MBPS/3MBPS',
        'I0112B_INTERNET CT 20MBPS/2MBPS GRUPO 2',
        'I0116B_INTERNET CT 20MBPS/3MBPS',
        'I0110_INTERNET CT 20MBPS/2MBPS',
        'RACSA INTERNET 2 MEGAS/512 KBPS',
        'I0112C_INTERNET CT 20MBPS/2MBPS GRUPO 3',
        'I0130_CT INTERNET 25MB/2MB',
        'I0120_INTERNET CT 25MBPS/5MBPS',
        'I0111_INTERNET CT 25MBPS/3MBPS',
        --FTTH
        '30MBPS/3MBPS_FTTH_CT',
        '300MBPS/150MBPS_FTTH_CT',
        'I01_INTERNET FTTH CT 2MBPS/1MBPS',
        'I02_INTERNET FTTH CT 3MBPS/2MBPS',
        'I10B_INTERNET FTTH CT 5M/3M GRUPO 2 V2',
        'I10A_INTERNET FTTH CT 5M/3M GRUPO 1',
        'I10A_INTERNET FTTH CT 5M/3M GRUPO 1 V2',
        'I03_INTERNET FTTH CT 6MBPS/4MBPS',
        'I01_INTERNET FTTH CT 10MBPS/6MBPS V1',
        'I04_INTERNET FTTH CT 10MBPS/6MBPS',
        'I04A_INTERNET FTTH CT 10MBPS/6MBPS GRUPO 1',
        'SERVICIO INTERNET FTTH 15MB/10MB V2',
        'I0141_INTERNET FTTH 15MBPS/10MBPS V3',
        'I10A_INTERNET FTTH CT 15M/10M GRUPO 1 V2',
        'I01_INTERNET FTTH CT 20MBPS/15MBPS V1',
        '3A_INTERNET CT 35MBPS/15MBPS FTTH V3A',
        '3_INTERNET CT 35MBPS/15MBPS FTTH V3',
        'I09B_INTERNET FTTH CT 35MBPS/15MBPS',
        'SERVICIO INTERNET FTTH 50MB/15MB V2',
        'I01C_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 3',
        'I01A_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 1',
        'I01B_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 2',
        'I02A_INTERNET FTTH CT 3MBPS/2MBPS GRUPO 1',
        'I02B_INTERNET FTTH CT 3MBPS/2MBPS GRUPO 2',
        'I10B_INTERNET FTTH CT 5M/3M GRUPO 2',
        'I10C_INTERNET FTTH CT 5M/3M GRUPO 3',
        '3030A_INTERNET FTTH CT 5M/3M GRUPO 1 V3',
        '3030B_INTERNET FTTH CT 5M/3M GRUPO 2 V3',
        '3030C_INTERNET FTTH CT 5M/3M GRUPO 3 V3',
        'I11A_INTERNET FTTH CT 8M/5M GRUPO 1',
        'I10C_INTERNET FTTH CT 15M/10M GRUPO 3 V2',
        '3030A_INTERNET FTTH CT 15MBPS/3MBPS GRUPO 1 V2',
        'I10B_INTERNET FTTH CT 15M/10M GRUPO 2 V2') THEN "Menor a 30"
        ELSE "ND" END AS VELOCIDADGRAL
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D`
    WHERE PD_BB_PROD_NM IS NOT NULL
GROUP BY ACT_ACCT_CD, VELOCIDADGRAL
 HAVING EXTRACT (MONTH FROM MAX(CST_CHRN_DT)) = EXTRACT (MONTH FROM MAX(FECHA_EXTRACCION))),
CRUCECHURNRGU AS(
    SELECT DISTINCT c.ACT_ACCT_CD, c.MaxFechaBB, b.VELOCIDADGRAL
    FROM CHURNERSBB c INNER JOIN CHURNPLANGRAL b ON c.ACT_ACCT_CD = b.ACT_ACCT_CD AND c.maxfechaBB = b.Maxfecha
),
CRUCECHURN AS
(
 SELECT DISTINCT c.ACT_ACCT_CD, c.MaxfechaBB AS FECHA,c.VELOCIDADGRAL, min(date(t.ACT_ACCT_INST_DT)) as MinInst
 FROM CRUCECHURNRGU c INNER JOIN `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D` t
 ON c.ACT_ACCT_CD = t.ACT_ACCT_CD AND c.MaxfechaBB = t.CST_CHRN_DT
 GROUP BY c.ACT_ACCT_CD, c.MaxfechaBB, c.VELOCIDADGRAL
),
TENUREACTIVOS AS(
    SELECT DISTINCT ACT_ACCT_CD, FECHA,VELOCIDADGRAL,
    CASE WHEN DATE_DIFF(FECHA,MinInst, DAY)<=90 AND MinInst < FECHA THEN "<3M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=180 AND DATE_DIFF(FECHA,MinInst, DAY)>90 THEN "03-6M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=270 AND DATE_DIFF(FECHA,MinInst, DAY)>180 THEN "06-9M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=360 AND DATE_DIFF(FECHA,MinInst, DAY)>270 THEN "09-1A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=720 AND DATE_DIFF(FECHA,MinInst, DAY)>360 THEN "1-2 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=1080 AND DATE_DIFF(FECHA,MinInst, DAY)>720 THEN "2-3 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=1440 AND DATE_DIFF(FECHA,MinInst, DAY)>1080 THEN "3-4 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)>1440 THEN "+4A" END AS TENURE
    FROM CRUCECHURN
)
SELECT EXTRACT (MONTH FROM FECHA)AS MES, VELOCIDADGRAL, TENURE, COUNT (DISTINCT ACT_ACCT_CD) as NumChurners
FROM TENUREACTIVOS
GROUP BY MES, VELOCIDADGRAL, TENURE
ORDER BY MES, VELOCIDADGRAL, TENURE
