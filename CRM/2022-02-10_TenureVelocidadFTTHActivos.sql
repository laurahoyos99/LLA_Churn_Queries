WITH ACTIVOSPLANFTTH AS(
 SELECT DISTINCT ACT_ACCT_CD, FECHA_EXTRACCION AS FECHA,
    CASE
    WHEN  PD_BB_PROD_NM IN (
        '3030A_INTERNET FTTH CT 35MBPS/15M GRUPO 1 V2',
        '3030B_INTERNET FTTH CT 35MBPS/15M GRUPO 2 V2',
        '3030C_INTERNET FTTH CT 35MBPS/15M GRUPO 3 V2',
        '30MBPS/30MBPS_FTTH_CT') THEN "30-35"
    WHEN PD_BB_PROD_NM IN (
        'I10B_INTERNET FTTH CT 50MBPS/15MBPS',
        'I01_INTERNET FTTH CT 50MBPS/15MBPS V1',
        'I11_INTERNET FTTH CT 75M/15M',
        '45MBPS/25MBPS_FTTH_CT') THEN "45-75"
    WHEN PD_BB_PROD_NM IN(
        '100MBPS/5MBPS_FTTH_CT',
        'I0141_INTERNET FTTH 100MBPS/15MBPS V3',
        'SERVICIO INTERNET FTTH 100MB/15MB V2',
        '3030B_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 2 V2',
        '3030A_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 1 V2',
        '3030C_INTERNET FTTH CT 100MBPS/15MBPS GRUPO 3 V2',
        'I01_INTERNET FTTH CT 100MBPS/15MBPS V1',
        '100MBPS/100MBPS_FTTH_CT') THEN "100"
    WHEN PD_BB_PROD_NM IN(
        '200MBPS/10MBPS_FTTH_CT',
        '200MBPS/200MBPS_FTTH_CT',
        '150MBPS/75MBPS_FTTH_CT') THEN "101-200"
    WHEN PD_BB_PROD_NM IN(
        '200MBPS/10MBPS_FTTH_CT') THEN "201-300"
    WHEN PD_BB_PROD_NM IN(
        '30MBPS/3MBPS_FTTH_CT',
        '300MBPS/150MBPS_FTTH_CT',
        'I01_INTERNET FTTH CT 2MBPS/1MBPS',
        'I02_INTERNET FTTH CT 3MBPS/2MBPS',
        'I10B_INTERNET FTTH CT 5M/3M GRUPO 2 V2',
        'I10A_INTERNET FTTH CT 5M/3M GRUPO 1',
        'I10A_INTERNET FTTH CT 5M/3M GRUPO 1 V2',
        'I03_INTERNET FTTH CT 6MBPS/4MBPS',
        'I01_INTERNET FTTH CT 10MBPS/6MBPS V1',
        'I04_INTERNET FTTH CT 10MBPS/6MBPS',
        'I04A_INTERNET FTTH CT 10MBPS/6MBPS GRUPO 1',
        'SERVICIO INTERNET FTTH 15MB/10MB V2',
        'I0141_INTERNET FTTH 15MBPS/10MBPS V3',
        'I10A_INTERNET FTTH CT 15M/10M GRUPO 1 V2',
        'I01_INTERNET FTTH CT 20MBPS/15MBPS V1',
        '3A_INTERNET CT 35MBPS/15MBPS FTTH V3A',
        '3_INTERNET CT 35MBPS/15MBPS FTTH V3',
        'I09B_INTERNET FTTH CT 35MBPS/15MBPS',
        'SERVICIO INTERNET FTTH 50MB/15MB V2',
        'I01C_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 3',
        'I01A_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 1',
        'I01B_INTERNET FTTH CT 2MBPS/1MBPS GRUPO 2',
        'I02A_INTERNET FTTH CT 3MBPS/2MBPS GRUPO 1',
        'I02B_INTERNET FTTH CT 3MBPS/2MBPS GRUPO 2',
        'I10B_INTERNET FTTH CT 5M/3M GRUPO 2',
        'I10C_INTERNET FTTH CT 5M/3M GRUPO 3',
        '3030A_INTERNET FTTH CT 5M/3M GRUPO 1 V3',
        '3030B_INTERNET FTTH CT 5M/3M GRUPO 2 V3',
        '3030C_INTERNET FTTH CT 5M/3M GRUPO 3 V3',
        'I11A_INTERNET FTTH CT 8M/5M GRUPO 1',
        'I10C_INTERNET FTTH CT 15M/10M GRUPO 3 V2',
        '3030A_INTERNET FTTH CT 15MBPS/3MBPS GRUPO 1 V2',
        'I10B_INTERNET FTTH CT 15M/10M GRUPO 2 V2') THEN "Menor a 30"
        ELSE "ND" END AS VELOCIDADFTTH
    FROM `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D`
    WHERE PD_BB_PROD_NM IS NOT NULL
GROUP BY ACT_ACCT_CD, VELOCIDADFTTH, FECHA),
CRUCEACTIVOS AS(
    SELECT DISTINCT a.ACT_ACCT_CD, FECHA, VELOCIDADFTTH,  min(date(ACT_ACCT_INST_DT)) as MinInst
    FROM ACTIVOSPLANFTTH a INNER JOIN `gcp-bia-tmps-vtr-dev-01.gcp_temp_cr_dev_01.2022-02-02_CRM_BULK_FILE_FINAL_HISTORIC_DATA_2021_D` t
    ON a.ACT_ACCT_CD = t.ACT_ACCT_CD AND a.FECHA = t.FECHA_EXTRACCION
    GROUP BY ACT_ACCT_CD, FECHA, VELOCIDADFTTH
),
TENUREACTIVOS AS(
    SELECT DISTINCT ACT_ACCT_CD, FECHA,VELOCIDADFTTH,
    CASE WHEN DATE_DIFF(FECHA,MinInst, DAY)<=90 AND MinInst < FECHA THEN "<3M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=180 AND DATE_DIFF(FECHA,MinInst, DAY)>90 THEN "03-6M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=270 AND DATE_DIFF(FECHA,MinInst, DAY)>180 THEN "06-9M"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=360 AND DATE_DIFF(FECHA,MinInst, DAY)>270 THEN "09-1A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=720 AND DATE_DIFF(FECHA,MinInst, DAY)>360 THEN "1-2 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=1080 AND DATE_DIFF(FECHA,MinInst, DAY)>720 THEN "2-3 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)<=1440 AND DATE_DIFF(FECHA,MinInst, DAY)>1080 THEN "3-4 A"
    WHEN DATE_DIFF(FECHA,MinInst, DAY)>1440 THEN "+4A" END AS TENURE
    FROM CRUCEACTIVOS
)
SELECT EXTRACT (MONTH FROM FECHA)AS MES, VELOCIDADFTTH, TENURE, COUNT (DISTINCT ACT_ACCT_CD) as NumContratos
FROM TENUREACTIVOS
GROUP BY MES, VELOCIDADFTTH, TENURE
ORDER BY MES, VELOCIDADFTTH, TENURE
